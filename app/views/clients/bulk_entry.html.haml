%h1 Bulk Entry of Clients

- no_of_fields = params[:clients] ? params[:clients].keys.count : 4
= form :action => url(:controller => :clients, :action => :bulk_entry, :method => :post) do
  %table.tall.shaded
    %tr
      %th
        In branch
      %td
        = select :name => 'branch_id', :id => "branch_selector", :collection => Branch.all, :text_method => :name, :value_method => :id, :selected => params[:branch_id].to_s, :prompt => 'Select a branch', :selected => params[:branch_id], :class => 'chosen'
    %tr
      %th
        and center
      %td
        = select :name => 'center_id', :id => 'center_selector', :collection => Center.all(:branch_id => params[:branch_id]), :text_method => :name, :value_method => :id, :selected => params[:center_id].to_s, :prompt => 'Select a center', :selected => params[:center_id], :class => 'chosen', :style => "width: 300px"
        - if @errors[:center]
          %span.red
            = @errors[:center]

  - ((params[:clients] or Nothing).keys || (1..5)).each do |i|
    - if (@errors or Nothing)[i] 
      %tr
        %td{:colspan => 10}
          .error
            - @errors.map do |k,v|
              - v.keys.each do |key|
                == #{key} : #{v[key]}
                
  %table.tall.shaded
    %tr
      %th
        Name
      - (1..no_of_fields).each do |i|
        %td
          = text_field :name => "clients[#{i}][name]", :value => (params[:clients] and params[:clients][i.to_s][:name]), :tabindex => 1*i
    %tr
      %th
        Ration Card
      - (1..no_of_fields).each do |i|
        %td
          = text_field :name => "clients[#{i}][reference]", :value => (params[:clients] and params[:clients][i.to_s][:reference]), :tabindex => 1*i
          = hidden_field :name => "clients[#{i}][reference_type]", :value => "Ration Card"
    %tr
      %th
        ID Proof
      - (1..no_of_fields).each do |i| 
        %td
          = text_field :name => "clients[#{i}][reference2]", :value => (params[:clients] and params[:clients][i.to_s][:reference]), :tabindex => 1*i
    %tr
      %th
        ID Proof Type
      - (1..no_of_fields).each do |i|
        %td
          = select :name => "clients[#{i}][reference2_type]", :value => (params[:clients] and params[:clients][i.to_s][:reference2_type]), :collection => Constants::Masters::REFERENCE_TYPES_ID_PROOF, :tabindex => 1*i
    %tr
      %th
        D.O.B.
      - (1..no_of_fields).each do |i|
        %td
          = text_field :name => "clients[#{i}][date_of_birth]", :value => (params[:clients] and params[:clients][i.to_s][:date_of_birth]), :tabindex => 1*i
          /= date_select "clients[#{i}][date_of_birth]", (params[:clients] and params[:clients][i.to_s][:date_of_birth]), :id => "client_#{i}_dob", :min_date => Date.today-36500, :max_date => Date.today-1000, :tabindex => 1*i
    %tr
      %th
        Date joined
      - (1..no_of_fields).each do |i|
        %td
          = text_field :name => "clients[#{i}][date_joined]", :value => (params[:clients] and params[:clients][i.to_s][:date_joined]), :tabindex => 1*i
          /= date_select "clients[#{i}][date_joined]", (params[:clients] and params[:clients][i.to_s][:date_joined]), :id => "client_#{i}_date_joined", :max_date => Date.today, :tabindex => 1*i
    %tr
      %th
        Kin name
      - (1..no_of_fields).each do |i|
        %td
          = text_area :name => "clients[#{i}][next_to_kin]", :value => (params[:clients] and params[:clients][i.to_s][:next_to_kin]), :tabindex => 1*i
    %tr
      %th
        Kin relationship
      - (1..no_of_fields).each do |i|
        %td
          = select :name => "clients[#{i}][next_to_kin_relationship]", :value => (params[:clients] and params[:clients][i.to_s][:next_to_kin_relationship]), :collection => ["Husband", "Father"], :tabindex => 1*i
    %tr
      %th
        Address
      - (1..no_of_fields).each do |i|
        %td
          = text_area :name => "clients[#{i}][address]", :value => (params[:clients] and params[:clients][i.to_s][:address]), :tabindex => 1*i
    %tr
      %th
        State
      - (1..no_of_fields).each do |i|
        %td
          = select :name => "clients[#{i}][state]", :collection => STATES, :selected => (params[:clients] and params[:clients][i.to_s][:state]).to_s, :tabindex => 1*i, :class => "chosen", :prompt => "Select"
    %tr
      %th
        Pincode
      - (1..no_of_fields).each do |i|
        %td
          = text_area :name => "clients[#{i}][pincode]", :value => (params[:clients] and params[:clients][i.to_s][:pincode]), :tabindex => 1*i
  = submit 'add clients'             
  -# %table
  -#   %thead
  -#     %tr
  -#       %th
  -#         Name
  -#       %th
  -#         Reference
  -#       %th
  -#         D.O.B.
  -#       %th
  -#         Date joined
  -#       %th
  -#         Address
      
  -#   - ((params[:clients] or Nothing).keys || (1..5)).each do |i|
  -#     - if (@errors or Nothing)[i] 
  -#       %tr
  -#         %td{:colspan => 10}
  -#           .error
  -#             - @errors.map do |k,v|
  -#               - v.keys.each do |key|
  -#                 == #{key} : #{v[key]}
  -#     %tr
  -#       %th
  -#         = text_field :name => "clients[#{i}][name]", :value => (params[:clients] and params[:clients][i.to_s][:name])
  -#       %th
  -#         = text_field :name => "clients[#{i}][reference]", :value => (params[:clients] and params[:clients][i.to_s][:reference])
  -#       %th
  -#         = date_select "clients[#{i}][date_of_birth]", (params[:clients] and params[:clients][i.to_s][:date_of_birth]), :id => "client_#{i}_dob", :min_date => Date.today-36500, :max_date => Date.today-1000
  -#       %th
  -#         = date_select "clients[#{i}][date_joined]", (params[:clients] and params[:clients][i.to_s][:date_joined]), :id => "client_#{i}_date_joined", :max_date => Date.today
  -#       %th
  -#         = text_field :name => "clients[#{i}][address]", :value => (params[:clients] and params[:clients][i.to_s][:address])
  -# = submit 'add clients' 
