%h1 Bulk Entry of Clients

- no_of_fields = params[:clients] ? params[:clients].keys.count : 4
- text_field_size = 8 
= form :action => url(:controller => :clients, :action => :bulk_entry, :method => :post) do
  %table.tall.shaded
    %tr
      %th
        In branch
      %td
        = select :name => 'branch_id', :id => "branch_selector", :collection => get_accessible_branches, :text_method => :name, :value_method => :id, :selected => params[:branch_id].to_s, :prompt => 'Select a branch', :selected => params[:branch_id], :class => 'chosen'
      %th
        and center
      %td
        = select :name => 'center_id', :id => 'center_selector', :collection => Center.all(:branch_id => params[:branch_id]), :text_method => :name, :value_method => :id, :selected => params[:center_id].to_s, :prompt => 'Select a center', :selected => params[:center_id], :class => 'chosen', :style => "width: 300px"
        - if @errors[:center]
          %span.red
            = @errors[:center]

  %table
    %thead
      %tr
        %th
          name
        %th
          ration card
        %th
          reference
        %th
          reference type
        %th
          d.o.b.
        %th
          date joined
        %th
          kin name
        %th
          kin relationship
        %th
          address
        %th
          state
        %th
          pincode
      
    - ((params[:clients] or Nothing).keys || (1..5)).each do |i|
      - if (@errors or Nothing)[i] 
        %tr
          %td{:colspan => 11}
            .error
              - @errors.map do |k,v|
                - v.keys.each do |key|
                  = "#{key} : #{v[key]}"
      %tr
        %th
          = text_field :name => "clients[#{i}][name]", :value => (params[:clients] and params[:clients][i.to_s][:name]), :size => 15
        %th
          = text_field :name => "clients[#{i}][ration_card_number]", :value => (params[:clients] and params[:clients][i.to_s][:ration_card_number]), :size => text_field_size
        %th
          = text_field :name => "clients[#{i}][reference]", :value => (params[:clients] and params[:clients][i.to_s][:reference]), :size => text_field_size
        %th
          = select :name => "clients[#{i}][type_of_id]", :selected => (params[:clients] and params[:clients][i.to_s][:type_of_id]), :collection => ID_TYPES,  :prompt => "Select", :class => "chosen"
        %th
          = text_field :name => "clients[#{i}][date_of_birth]", :value => (params[:clients] and params[:clients][i.to_s][:date_of_birth]), :size => text_field_size
          /= date_select "clients[#{i}][date_of_birth]", (params[:clients] and params[:clients][i.to_s][:date_of_birth]), :id => "client_#{i}_dob", :min_date => Date.today-36500, :max_date => Date.today-1000, :size => text_field_size
        %th
          = text_field :name => "clients[#{i}][date_joined]", :value => (params[:clients] and params[:clients][i.to_s][:date_joined]), :size => text_field_size
          /= date_select "clients[#{i}][date_joined]", (params[:clients] and params[:clients][i.to_s][:date_joined]), :id => "client_#{i}_date_joined", :max_date => Date.today, :size => text_field_size
        %th
          = text_field :name => "clients[#{i}][next_to_kin]", :value => (params[:clients] and params[:clients][i.to_s][:next_to_kin]), :size => 15
        %th
          = select :name => "clients[#{i}][next_to_kin_relationship]", :selected => (params[:clients] and params[:clients][i.to_s][:next_to_kin_relationship]), :collection => ["Husband", "Father"], :prompt => "Select", :class => "chosen"
        %th
          = text_field :name => "clients[#{i}][address]", :value => (params[:clients] and params[:clients][i.to_s][:address])
        %th
          = select :name => "clients[#{i}][state]", :collection => STATES, :selected => (params[:clients] and params[:clients][i.to_s][:state]).to_s, :prompt => "Select", :class => "chosen"
        %th
          = text_field :name => "clients[#{i}][pincode]", :value => (params[:clients] and params[:clients][i.to_s][:pincode]), :size => text_field_size
  = submit 'add clients'