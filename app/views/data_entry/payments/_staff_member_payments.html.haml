- if @centers.count>0
  Payment collected on
  = date_select "received_on", @date
  by
  = select :name => "payment[received_by]", :collection => staff_members_collection, :selected => @staff_member.id.to_s, :id => 'payments_received_by', :class => "chosen"
  - @centers.each do |center|
    %h1
      = center.name
    %table.report.nojs
      %thead{:onclick => "javascript:$('#t_#{center.id}').toggle()"}
        %tr{:style => "font-size: 0.85em;"}
          %th client
          %th loan
          %th principal due
          %th interest due
          %th fees_due
          %th total due
          %th paid
          %th repay type
          %th attendance
          
      %tbody{:style => "text-align:left;display:none;", :id => "t_#{center.id}"}
        - tot_amount, tot_outstanding, tot_installments, tot_principal, tot_interest, tot_fees, tot_total = 0, 0, 0, 0, 0, 0, 0
        - clients_by_center = center.clients.group_by{|c| c.client_group_id}.each do |group_id, clients|
          %tr.group{:style => 'font-weight: bold; text-align: center; background: grey'}
            %td{:colspan => 12}
              = @client_groups[group_id]
          - clients.each do |client|
            - loan_row_count = 0
            - @loans.find_all{|l| l.client_id == client.id and l.disbursal_date}.each do |loan|
              - lh = @loan_histories.find_all{|x| x.loan_id==loan.id}.sort_by{|x| x.created_at}[-1]
              - next if not lh
              - next if LOANS_NOT_PAYABLE.include? lh.status
              - loan_row_count += 1
              - if lh
                - p = [lh.principal_due, 0].max
                - i = [lh.interest_due,0].max
                - f = [lh.fees_due_today,0].max
              - else
                - p = 0
                - i = 0

              %tr{ :class => cycle('odd','even') }
                %td.text
                  %b= link_to client.name, resource(client)
                %td.number
                  = link_to loan.id, url_for_loan(loan)
                %td.number
                  = p.round(2)
                  - tot_principal += p
                %td.number
                  = i.round(2)
                  - tot_interest += i
                %td.number
                  = f.round(2).to_currency
                  - tot_fees += f.round(2)
                %td.number
                  - a = p + i + f
                  = a.round(2)
                  - tot_total += a
                %td.paid
                  -# - if a > 0.01
                  = text_field :name => "paid[loan][#{loan.id}]", :value => [a,0].max.round(2), :cols => "5", :style => "width:50px;" 
                  -# - else
                  -#   = lh.principal_paid + lh.interest_paid
                %td 
                  = repayment_style_select "payment_style[#{loan.id}]"
                %td
                  = select :name => "attendance[#{client.id}]", :collection => Attendance.attendancy_states, :value_method => :to_s, :selected => (@atts[client.id] || "present")
            - if loan_row_count == 0
              %tr{ :class => cycle('odd','') }
                %td.text
                  %b= link_to client.name, resource(client)
                %td{ :colspan => 9 }
                  %i nothing outstanding
                %td
                  = select :name => "attendance[#{client.id}]", :collection => Attendance.attendancy_states, :value_method => :to_s, :selected => (@atts[client.id] || "present")

      %tfoot{:onclick => "javascript:$('#t_#{center.id}').toggle()"}    
        %tr.total
          %td
          %td
          %td.numeric
            %b= tot_principal.to_currency
          %td.numeric
            %b= tot_interest.to_currency
          %td
            %b= tot_fees.to_currency
          %td
            %b= tot_total.to_currency
          %td
          %td
          %td
- else
  %i This staff member has no collections today