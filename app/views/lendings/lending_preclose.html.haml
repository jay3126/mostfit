%h1 Preclose loan
.shaded
  = form_for(@lending, :action => url(:controller => :lendings, :action => :check_preclosure_date)) do
    = hidden_field :name => "loan_id", :value => @lending.id
    %table
      %tr
        %td
          %b= "Preclose on date:"
        %td
          = date_select :effective_on, Date.today, :min_date => @lending.most_recent_payment_transaction_on_date, :max_date => Date.today
          = submit "Go"

  - unless params[:effective_on].blank?
    - effective_on_date_str = params[:effective_on]
    - effective_on_date = Date.parse(effective_on_date_str)
    - preclosure_date_condition = effective_on_date && (effective_on_date > @lending.most_recent_payment_transaction_on_date && effective_on_date < Date.today)

    - if preclosure_date_condition
      = partial :preclosure_form, :preclose_on_date => params[:effective_on]