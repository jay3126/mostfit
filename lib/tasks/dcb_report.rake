require "rubygems"

# Add the local gems dir if found within the app root; any dependencies loaded
# hereafter will try to load from the local gems before loading system gems.
if (local_gem_dir = File.join(File.dirname(__FILE__), '..', '..', 'gems')) && $BUNDLE.nil?
  $BUNDLE = true; Gem.clear_paths; Gem.path.unshift(local_gem_dir)
end

require "merb-core"

# this loads all plugins required in your init file so don't add them
# here again, Merb will do it for you
Merb.start_environment(:environment => ENV['MERB_ENV'] || 'development')

namespace :mostfit do
  desc "This report gives DCB report for Intellecash"
  task :dcb_report do
    branch_ids = [1, 2, 3, 4, 5, 6, 7, 8, 9]

    center_ids = [275,271,383,240,270,205,749,747,135,243,147,268,266,265,750,279,276,291,282,123,184,267,254,752,709,753,273,159,302,156,284,754,755,751,238,290,288,263,756,456,758,83,170,101,277,218,97,280,759,760,763,757,597,103,764,188,39,204,33,390,471,761,651,762,765,766,769,770,767,771,772,311,290,303,187,287,193,202,661,774,777]

    client_ids = [4634,4621,4636,4629,4637,4639,4574,4641,4642,4571,4622,4558,4635,4627,4567,4577,4568,4575,4582,4640,4625,4638,4581,4631,4563,4569,3856,4579,4572,4561,6713,6721,6706,6711,6723,6705,6708,6715,6724,6716,13760,13761,4121,4150,4122,4116,4117,4148,4147,4151,4553,4556,4555,4557,4554,4559,4560,4566,4562,4564,13762,3530,3488,3521,3494,3508,3491,3519,3505,3497,3475,3474,3477,13763,13764,13765,13767,13768,13769,13766,13750,13749,13748,13747,13746,13745,13744,13743,13742,13741,13740,13739,13738,13737,13736,5491,5490,5492,5489,13801,4145,4149,4136,4137,4141,3701,4130,4171,3702,4126,3704,3920,4139,3705,13788,4285,4276,4274,4280,4535,4279,4534,4517,4506,4530,4508,4529,4511,4509,4531,4513,4528,4516,4536,4512,4532,13778,4537,13779,4533,4505,13771,13772,4510,13773,4503,13774,13776,13775,13777,4502,13789,4501,13790,4500,13791,4499,4498,13792,13794,13796,13797,13798,13799,13800,13807,13808,4716,4707,13822,13817,13819,13821,4664,4658,4657,4703,4649,4704,4666,4721,4710,4646,4714,4652,4712,4668,13805,13806,4665,4894,4647,4901,4656,4898,4661,4667,4900,4669,4893,4651,4896,4655,4895,4897,4773,13818,4299,4772,4313,4783,4311,4308,13820,2441,4781,4769,13780,4774,13781,4778,13782,4770,13783,4779,4373,4371,4768,4375,4776,4368,4777,4370,4775,3095,13770,13811,13810,4335,4328,13809,4527,4333,4520,4334,4519,4522,4337,4521,4342,4518,4339,4341,4340,4338,13847,13846,13845,13842,13840,13839,13837,13833,13832,13831,13830,13827,13825,13824,13823,13795,13793,13802,13803,13804,13859,13861,13860,13862,13863,13864,13865,13867,13869,13871,4598,4609,4607,4608,4618,4611,4614,4599,4613,4620,4601,13814,4616,4605,13812,2707,13844,13849,2711,2724,2721,2715,4541,4547,4546,4543,4538,13848,13843,13841,13838,13835,13853,13851,13854,5664,5123,5666,4493,4494,4496,5665,4497,5663,13856,13826,13850,13828,13829,13852,13836,4815,13834,4810,4818,3634,4806,4809,4817,3635,13905,13903,13902,13901,13900,13899,13898,13897,13896,13895,13885,13886,13887,13888,13889,13890,13891,13892,13893,13894,13883,13882,13881,13884,13858,13857,13855,13816,13815,13813,4095,13784,13785,13786,13787,4886,4888,4890,4891,4882,4860,4858,4856,4865,4854,4864,4863,4855,13937,13938,4475,4479,4476,4474,4472,4486,4487,4481,4483,4480,1791,13872,13873,13874,13875,13876,13877,13878,13879,13880,13914,13915,13916,13917,13918,13919,13921,13922,13924,13925,13907,13908,13909,13910,13912,13939,13940,13941,13942,1883,3458,1897,3461,3460,1881,4840,4839,4841,4838,4842,4844,4847,4843,4846,13926,4849,4852,4848,4851,13920,4660,4645,4663,4653,4673,4643,4681,4650,13904,13906,4112,4766,4119,4120,13923,13911,13913,3286,3066,3060,4760,13943,4722,4726,4742,4720,4736,4739,4731,4733,13944,4752,4749,4750,4719,4745,4713,4717,4711,4715,13945,13946,13947,13948,13949,13950,13951,13952,13953,13954,13955,13956,13957,13958,13959,13960,13961,13962,13963,13964,13979,13978,13977,13976,13975,13974,13973,13972,13971,13970,13969,13968,13967,13966,13965,13994,13993,13992,13991,13990,13989,13988,13987,13986,13985,13984,13983,13982,13981,13980,13927,13928,13929,13930,13931,13932,13933,13934,13935,13936,14000,14001,14002,14005,14003,13995,13996,13997,13998,13999,2478,4190,4197,2482,14004,4200,4199,4196,4201,2481,2479,14006,14007,14008,14009,3166,3165,4001,3167,717,14010,14011,14012,14013,14014,13868,13870,13866,737,1052,736,735,1055,728,738,14021,14020,14018,14016,14015,5065,5067,5070,4078,5071,5063,5072,14017,14019,6815,14022,6821,6817,6820,6824,6822,14023,14024,14025,6805,1907,752,14034,14036,14038,14039,14041,14043,14044,14045,14026,14027,14028,14029,14030,14031,14032,14033,14035,14037,14040,14042,14046,14047,14048,14049,14050,14051,14052,14053,14055,14054,14056,14057,14058,14059,14060,14061,14062,14063,14064,14065,14066,14067,14068,14084,14085,14086,14087,14088,14089,14090,14091,14092,14093,14094,14095,14096,14097,14098,14099,14100,14101,14102,14105,14106,14107,14109,14111,14113,14115,14117,14118,14119,14120,14103,14104,14108,14110,14112,14114,14116,14129,14121,14122,14123,14124,14126,14127,14128,14143,14142,14141,14069,14140,14139,14138,14137,14070,14071,14072,14136,14073,14074,14075,14076,14077,14078,14079,14080,14081,14082,14135,14083,14134,14133,14132,14131,14130,14125,14152,14144,14145,14146,14147,14153,14151,14150,14148,14149,14154,14155,14156,14157,14158,14159,14160,14161,14162,14163,14164,14165,14166,14167,14168,5282,5271,5268,5285,2446,5290,5292,5298,5289,5295,14169,5301,5306,4885,5311,4884,5326,5330,5324,5308,5109,5111,5113,5108,5110,4834,4835,4837,3153,4859,4907,4906,4903,4690,4700,4836,4699,4697,14170,4694,4857,5015,5016,5013,4861,5017,14172,5014,14173,14175,5012,5008,5024,5010,5009,5027,5011,5025,5026,5023,14194,14195,14196,14197,14198,14199,14200,14201,14202,14203,14184,14185,14186,14187,14188,14189,14190,14191,14192,14193,14225]

    loan_ids = [16436,16437,16438,16439,16440,16441,16442,16443,16444,16445,16446,16447,16448,16449,16450,16451,16452,16453,16454,16455,16456,16457,16458,16459,16460,16461,16462,16463,16464,16465,16466,16467,16468,16469,16470,16471,16472,16473,16474,16475,16476,16477,16478,16479,16480,16481,16482,16483,16484,16485,16486,16487,16488,16489,16490,16491,16492,16493,16494,16495,16496,16497,16498,16499,16500,16501,16502,16503,16504,16505,16506,16507,16508,16509,16510,16511,16512,16513,16514,16515,16516,16517,16518,16519,16520,16521,16522,16523,16524,16525,16526,16527,16528,16529,16530,16531,16532,16533,16534,16535,16536,16537,16538,16539,16540,16541,16542,16543,16544,16545,16546,16547,16548,16549,16550,16551,16552,16553,16554,16555,16556,16557,16558,16559,16560,16561,16562,16563,16564,16565,16566,16567,16568,16569,16570,16571,16572,16573,16574,16575,16576,16577,16578,16579,16580,16581,16582,16583,16584,16585,16586,16587,16588,16589,16590,16591,16592,16593,16594,16595,16596,16597,16598,16599,16600,16601,16602,16603,16604,16605,16606,16607,16608,16609,16610,16611,16612,16613,16614,16615,16616,16617,16618,16619,16620,16621,16622,16623,16624,16625,16626,16627,16628,16629,16630,16631,16632,16633,16634,16635,16636,16637,16638,16639,16640,16641,16642,16643,16644,16645,16646,16647,16648,16649,16650,16651,16652,16653,16654,16655,16656,16657,16658,16659,16660,16661,16662,16663,16664,16665,16666,16667,16668,16669,16670,16671,16672,16673,16674,16675,16676,16677,16678,16679,16680,16681,16682,16683,16684,16685,16686,16687,16688,16689,16690,16691,16692,16693,16694,16695,16696,16697,16698,16699,16700,16701,16702,16703,16704,16705,16706,16707,16708,16709,16710,16711,16712,16713,16714,16715,16716,16717,16718,16719,16720,16721,16722,16723,16724,16725,16726,16727,16728,16729,16730,16731,16732,16733,16734,16735,16736,16737,16738,16739,16740,16741,16742,16743,16744,16745,16746,16747,16748,16749,16750,16751,16752,16753,16754,16755,16756,16757,16758,16759,16760,16761,16762,16763,16764,16765,16766,16767,16768,16769,16770,16771,16772,16773,16774,16775,16776,16777,16778,16779,16780,16781,16782,16783,16784,16785,16786,16787,16788,16789,16790,16791,16792,16793,16794,16795,16796,16797,16798,16799,16800,16801,16802,16803,16804,16805,16806,16807,16808,16809,16810,16811,16812,16813,16814,16815,16816,16817,16818,16819,16820,16821,16822,16823,16824,16825,16826,16827,16828,16829,16830,16831,16832,16833,16834,16835,16836,16837,16838,16839,16840,16841,16842,16843,16844,16845,16846,16847,16848,16849,16850,16851,16852,16853,16854,16855,16856,16857,16858,16859,16860,16861,16862,16863,16864,16865,16866,16867,16868,16869,16870,16871,16872,16873,16874,16875,16876,16877,16878,16879,16880,16881,16882,16883,16884,16885,16886,16887,16888,16889,16890,16891,16892,16893,16894,16895,16896,16897,16898,16899,16900,16901,16902,16903,16904,16905,16906,16907,16908,16909,16910,16911,16912,16913,16914,16915,16916,16917,16918,16919,16920,16921,16922,16923,16924,16925,16926,16927,16928,16929,16930,16931,16932,16933,16934,16935,16936,16937,16938,16939,16940,16941,16942,16943,16944,16945,16946,16947,16948,16949,16950,16951,16952,16953,16954,16955,16956,16957,16958,16959,16960,16961,16962,16963,16964,16965,16966,16967,16968,16969,16970,16971,16972,16973,16974,16975,16976,16977,16978,16979,16980,16981,16982,16983,16984,16985,16986,16987,16988,16989,16990,16991,16992,16993,16994,16995,16996,16997,16998,16999,17000,17001,17002,17003,17004,17005,17006,17007,17008,17009,17010,17011,17012,17013,17014,17015,17016,17017,17018,17019,17020,17021,17022,17023,17024,17025,17026,17027,17028,17029,17030,17031,17032,17033,17034,17035,17036,17037,17038,17039,17040,17041,17042,17043,17044,17045,17046,17047,17048,17049,17050,17051,17052,17053,17054,17055,17056,17057,17058,17059,17060,17061,17062,17063,17064,17065,17066,17067,17068,17069,17070,17071,17072,17073,17074,17075,17076,17077,17078,17079,17080,17081,17082,17083,17084,17085,17086,17087,17088,17089,17090,17091,17092,17093,17094,17095,17096,17097,17098,17099,17100,17101,17102,17103,17104,17105,17106,17107,17108,17109,17110,17111,17112,17113,17114,17115,17116,17117,17118,17119,17120,17121,17122,17123,17124,17125,17126,17127,17128,17129,17130,17131,17132,17133,17134,17135,17136,17137,17138,17139,17140,17141,17142,17143,17144,17145,17146,17147,17148,17149,17150,17151,17152,17153,17154,17155,17156,17157,17158,17159,17160,17161,17162,17163,17164,17165,17166,17167,17168,17169,17170,17171,17172,17173,17174,17175,17176,17177,17178,17179,17180,17181,17182,17183,17184,17185,17186,17187,17188,17189,17190,17191,17192,17193,17194,17195,17196,17197,17198,17199,17200,17201,17202,17203,17204,17205,17206,17207,17208,17209,17210,17211,17212,17213,17214,17215,17216,17217,17218,17219,17220,17221,17222,17223,17224,17225,17226,17227,17228,17229,17230,17231,17232,17233,17234,17235,17236,17237,17238,17239,17240,17241,17242,17243,17244,17245,17246,17247,17248,17249,17250,17251,17252,17253,17254,17255,17256,17257,17258,17259,17260,17261,17262,17263,17264,17265,17266,17267,17268,17269,17270,17271,17272,17273,17274,17275,17276,17277,17278,17279,17280,17281,17282,17283,17284,17285,17321]

    sl_no = 0   #this variable is for serial number.
    date = Date.new(2012, 02, 24)   #this date is to get the outstandings of loan.

    f = File.open("tmp/dcb_report_#{DateTime.now.to_s}.csv", "w")
    f.puts("\"Sl. No.\", \"Branch Id\", \"Branch Name\", \"Center Id\", \"Center Name\", \"Client Id\", \"Client Name\", \"Spouse Name\", \"Guarantor Name\", \"Occupation\", \"Gender\", \"Caste\", \"Religion\", \"Village\", \"Pin Code\", \"Loan Id\", \"Loan Amount\", \"Loan Status\", \"Cycle No.\", \"Interest Rate\", \"Tenor In Weeks\", \"Disbursement Mode\", \"Loan Purpose\", \"Disbursal Date\", \"Loan Start Date\", \"EWI Start Date\", \"EWI in Rs.\", \"Loan Maturity Date\", \"Week Since Disbursal\", \"Weeks Remaining\", \"Scheduled Outstanding Principal\", \"Scheduled Outstanding Interest\", \"Actual Outstanding Principal\", \"Actual Outstanding Interest\", \"Installments Paid\"")

    Loan.all(:c_branch_id => branch_ids, :c_center_id => center_ids, :client_id => client_ids, :id => loan_ids, :disbursal_date.gte => Date.new(2012, 02, 03), :disbursal_date.lte => Date.new(2012, 02, 15)).each do |l|

      sl_no += 1

      branch = Branch.get(l.c_branch_id)
      branch_id = branch.id
      branch_name = branch.name

      center = Center.get(l.c_center_id)
      center_id = center.id
      center_name = center.name

      client = Client.get(l.client_id)
      client_id = client.id
      client_name = client.name
      client_spouse_name = client.spouse_name
      client_guarantor_name = client.guarantors[0].name if client.guarantors[0]
      client_occupation = client.occupation.name
      client_gender = client.gender
      client_caste = client.caste
      client_religion = client.religion
      client_village = client.village.name if client.village
      client_pin_code = client.address_pin

      loan_id = l.id
      loan_amount = l.amount
      loan_status = l.status.to_s
      loan_cycle_number = l.cycle_number
      loan_interest_rate = (l.interest_rate * 100)
      loan_tenor_in_weeks = l.number_of_installments
      if l.cheque_number.empty?
        loan_disbursement_mode = "Cash"
      else
        loan_disbursement_mode = "Cheque"
      end
      loan_purpose = l.occupation.name
      loan_disbursal_date = l.disbursal_date
      loan_start_date = l.disbursal_date
      loan_ewi_date = l.scheduled_first_payment_date
      loan_ewi = (l.scheduled_principal_for_installment(1) + l.scheduled_interest_for_installment(1))
      loan_maturity_date = l.loan_history.last.date
      loan_weeks_since_disbursal = l.number_of_installments_before(date)
      loan_weeks_remaining = (l.number_of_installments - l.number_of_installments_before(date))
      loan_scheduled_outstanding_principal = l.scheduled_outstanding_principal_on(date)
      loan_scheduled_outstanding_interest = l.scheduled_outstanding_interest_on(date)
      loan_actual_outstanding_principal = l.actual_outstanding_principal_on(date)
      loan_actual_outstanding_interest = l.actual_outstanding_interest_on(date)
      loan_installments_paid = l.number_of_installments_before(date)

      f.puts("#{sl_no}, #{branch_id}, \"#{branch_name}\", #{center_id}, \"#{center_name}\", #{client_id}, \"#{client_name}\", \"#{client_spouse_name}\", \"#{client_guarantor_name}\", \"#{client_occupation}\", \"#{client_gender}\", \"#{client_caste}\", \"#{client_religion}\", \"#{client_village}\", #{client_pin_code}, #{loan_id}, #{loan_amount}, \"#{loan_status}\", #{loan_cycle_number}, #{loan_interest_rate}, #{loan_tenor_in_weeks}, \"#{loan_disbursement_mode}\", \"#{loan_purpose}\", #{loan_disbursal_date}, #{loan_start_date}, #{loan_ewi_date}, #{loan_ewi}, #{loan_maturity_date}, #{loan_weeks_since_disbursal}, #{loan_weeks_remaining}, #{loan_scheduled_outstanding_principal}, #{loan_scheduled_outstanding_interest}, #{loan_actual_outstanding_principal}, #{loan_actual_outstanding_interest}, #{loan_installments_paid}")
    end
    f.close
  end
end
